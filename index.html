<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Peta & Data</title>
    
    <!-- Leaflet CSS untuk Peta -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Trebuchet MS', sans-serif;
            background-color: #f8f9fa;
            color: #2c3e50;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            background: linear-gradient(to right, #ffffff 0%, #f0f7f5 100%);
            color: #2c3e50;
            padding: 15px 30px;
            border-radius: 0;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-bottom: 5px solid #1e8449;
            display: flex;
            align-items: center;
            gap: 25px;
        }

        .header-logo {
            flex-shrink: 0;
        }

        .header-logo img {
            height: 60px;
            width: auto;
        }

        .header-content h2 {
            font-size: 1.05em;
            color: #1e8449;
            font-weight: 700;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }

        .header-content h1 {
            font-size: 1.6em;
            margin: 0;
            color: #0b5394;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
            flex-wrap: wrap;
        }

        .nav-tabs button {
            padding: 14px 26px;
            border: none;
            background-color: #ffffff;
            color: #2c3e50;
            cursor: pointer;
            font-size: 15px;
            border-radius: 4px 4px 0 0;
            transition: all 0.3s ease;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            letter-spacing: 0.3px;
        }

        .nav-tabs button:hover {
            background-color: #f0f7f5;
            border-bottom-color: #0b5394;
            color: #0b5394;
        }

        .nav-tabs button.active {
            background: linear-gradient(to right, #0b5394, #1e8449);
            color: white;
            border-bottom-color: #0b5394;
        }

        /* Page Content */
        .pages {
            position: relative;
        }

        .page {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* PAGE 1: PETA */
        #mapContainer {
            width: 100%;
            height: 600px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
            border: 1px solid #e0e0e0;
            position: relative;
        }

        .map-page-wrapper {
            position: relative;
            height: 600px;
        }

        /* Sidebar */
        .map-sidebar {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 270px;
            background: white;
            box-shadow: 2px 0 8px rgba(0,0,0,0.15);
            z-index: 1000;
            overflow-y: auto;
            transition: transform 0.3s ease;
            border-radius: 4px 0 0 4px;
        }

        .map-sidebar.hidden {
            transform: translateX(-100%);
        }

        .sidebar-header {
            padding: 17px 13px;
            background: linear-gradient(to right, #0b5394, #1566a3);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
            border-bottom: 2px solid #1e8449;
        }

        .sidebar-header button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            cursor: pointer;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 15px;
            transition: background 0.3s ease;
        }

        .sidebar-header button:hover {
            background: rgba(255,255,255,0.4);
        }

        .sidebar-content {
            padding: 10px;
        }

        .layer-group {
            margin-bottom: 18px;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 12px;
        }

        .layer-group:last-child {
            border-bottom: none;
        }

        .layer-group-title {
            font-weight: 700;
            color: #0b5394;
            margin-bottom: 8px;
            font-size: 0.95em;
            display: flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .layer-group-title .toggle-icon {
            display: inline-block;
            margin-right: 8px;
            transition: transform 0.3s ease;
        }

        .layer-group-title.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .layer-items {
            display: none;
            padding-left: 15px;
        }

        .layer-items.show {
            display: block;
        }

        .layer-item {
            display: flex;
            align-items: center;
            margin-bottom: 7px;
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 6px;
            border-radius: 3px;
        }

        .layer-item:hover {
            background-color: #f0f7f5;
        }

        .layer-item input[type="checkbox"] {
            margin-right: 10px;
            cursor: pointer;
            width: 16px;
            height: 16px;
            accent-color: #0b5394;
        }

        .layer-item label {
            cursor: pointer;
            flex: 1;
            font-size: 0.9em;
            color: #2c3e50;
        }

        .toggle-sidebar-btn {
            position: absolute;
            left: 290px;
            top: 10px;
            background: white;
            border: 1px solid #ddd;
            padding: 8px 10px;
            border-radius: 4px;
            cursor: pointer;
            z-index: 999;
            transition: all 0.3s ease;
            font-size: 14px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .map-sidebar.hidden ~ .toggle-sidebar-btn {
            left: 10px;
        }

        .map-sidebar.hidden ~ .toggle-sidebar-btn::before {
            content: '‚Üí';
        }

        /* Map Controls */
        .map-top-right-controls {
            position: absolute;
            top: 15px;
            right: 10px;
            z-index: 999;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .map-control-btn {
            background: white;
            border: 1px solid #ddd;
            width: 42px;
            height: 42px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 15px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .map-control-btn:hover {
            background: #f0f7f5;
            border-color: #0b5394;
        }

        .layer-toggle-box {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            max-height: 250px;
            overflow-y: auto;
        }

        .layer-toggle-title {
            font-weight: 700;
            font-size: 0.85em;
            color: #0b5394;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e0e0e0;
        }

        .layer-toggle-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            font-size: 0.85em;
        }

        .layer-toggle-item input[type="checkbox"] {
            margin-right: 5px;
            cursor: pointer;
            accent-color: #0b5394;
        }

        /* Legenda */
        .map-legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            z-index: 500;
            font-size: 0.9em;
            display: none;
            max-width: 250px;
        }

        .map-legend.show {
            display: block;
        }

        .map-legend-title {
            font-weight: 700;
            color: #0b5394;
            margin-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 8px;
        }

        .map-legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 4px;
        }

        .map-legend-color {
            width: 16px;
            height: 16px;
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            flex-shrink: 0;
        }

        .map-legend-color.green {
            background: #2ecc71;
        }

        .map-legend-color.yellow {
            background: #f39c12;
        }

        .map-legend-color.red {
            background: #e74c3c;
        }

        .map-legend-color.black {
            background: #2c3e50;
        }

        .map-legend-label {
            color: #2c3e50;
            font-size: 0.9em;
        }

        .map-popup {
            background: white;
            border-radius: 4px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            position: fixed;
            max-width: 280px;
            z-index: 2000;
            display: none;
            border-left: 4px solid #1e8449;
        }

        .map-popup.show {
            display: block;
            animation: popupSlide 0.3s ease;
        }

        @keyframes popupSlide {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .map-popup-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            border-bottom: 2px solid #f0f7f5;
            padding-bottom: 8px;
        }

        .map-popup-title {
            font-weight: 700;
            color: #0b5394;
            font-size: 0.95em;
            flex: 1;
        }

        .map-popup-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s ease;
        }

        .map-popup-close:hover {
            color: #0b5394;
        }

        .map-popup-content {
            font-size: 0.9em;
            color: #2c3e50;
            line-height: 1.6;
        }

        .map-popup-item {
            margin-bottom: 8px;
            display: flex;
        }

        .map-popup-label {
            font-weight: 600;
            color: #0b5394;
            min-width: 80px;
            margin-right: 5px;
        }

        .map-popup-value {
            color: #555;
        }

        /* Detail Popup (Kendala Operasional) */
        .detail-popup {
            background: white;
            border-radius: 4px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            position: fixed;
            max-width: 320px;
            z-index: 2001;
            display: none;
            border-left: 4px solid #e74c3c;
            max-height: 400px;
            overflow-y: auto;
        }

        .detail-popup.show {
            display: block;
            animation: popupSlide 0.3s ease;
        }

        .detail-popup-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            border-bottom: 2px solid #f0f7f5;
            padding-bottom: 10px;
        }

        .detail-popup-title {
            font-weight: 700;
            color: #e74c3c;
            font-size: 1em;
        }

        .detail-popup-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s ease;
        }

        .detail-popup-close:hover {
            color: #e74c3c;
        }

        .detail-popup-content {
            font-size: 0.9em;
            color: #2c3e50;
            line-height: 1.6;
        }

        /* PAGE 2: METADATA */
        .metadata-content {
            background: white;
            padding: 30px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-top: 4px solid #1e8449;
        }

        .metadata-content h2 {
            color: #0b5394;
            margin-bottom: 25px;
            font-size: 1.8em;
            font-weight: 700;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #0b5394 0%, #1e8449 100%);
            color: white;
            padding: 25px;
            border-radius: 4px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-left: 5px solid #ffffff;
        }

        .stat-card h3 {
            font-size: 0.95em;
            opacity: 0.95;
            margin-bottom: 12px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .stat-card .value {
            font-size: 2.5em;
            font-weight: 700;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table thead {
            background: linear-gradient(to right, #0b5394, #1566a3);
            color: white;
        }

        .data-table th {
            padding: 15px;
            text-align: left;
            font-weight: 700;
            border: none;
            letter-spacing: 0.3px;
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            color: #2c3e50;
        }

        .data-table tbody tr:hover {
            background-color: #f0f7f5;
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            max-width: 400px;
            padding: 11px 15px;
            border: 1px solid #d0d0d0;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: #0b5394;
        }

        /* PAGE 3: UPDATE DATA */
        .form-container {
            background: white;
            padding: 30px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            max-width: 600px;
            border-top: 4px solid #1e8449;
        }

        .form-container h2 {
            color: #0b5394;
            margin-bottom: 25px;
            font-size: 1.8em;
            font-weight: 700;
        }

        .form-group {
            margin-bottom: 22px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
            color: #2c3e50;
            font-size: 14px;
            letter-spacing: 0.3px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 11px 12px;
            border: 1px solid #d0d0d0;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
            background-color: #ffffff;
            transition: border-color 0.3s ease;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #0b5394;
            box-shadow: 0 0 5px rgba(11, 83, 148, 0.2);
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 30px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            font-size: 15px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.3s ease;
            letter-spacing: 0.3px;
        }

        .btn-primary {
            background: linear-gradient(to right, #0b5394, #1566a3);
            color: white;
            flex: 1;
        }

        .btn-primary:hover {
            background: linear-gradient(to right, #0a3d6d, #0d4a7a);
            box-shadow: 0 4px 12px rgba(11, 83, 148, 0.3);
        }

        .btn-secondary {
            background-color: #e8e8e8;
            color: #2c3e50;
            flex: 1;
        }

        .btn-secondary:hover {
            background-color: #d5d5d5;
        }

        .message {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
            font-weight: 600;
        }

        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .header-logo img {
                height: 60px;
            }

            .header-content h1 {
                font-size: 1.8em;
            }

            .nav-tabs {
                flex-direction: column;
            }

            .nav-tabs button {
                width: 100%;
                border-radius: 4px;
            }

            #mapContainer {
                height: 400px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .map-controls {
                flex-direction: column;
            }

            .map-controls input,
            .map-controls button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-logo">
                <img src="Logo_BMKG.png" alt="Logo BMKG">
            </div>
            <div class="header-content">
                <h2>Direktorat Meteorologi Penerbangan</h2>
                <h1>Dashboard ALOPTAMA</h1>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-btn active" data-page="page1">üó∫Ô∏è Peta Sebaran Alat</button>
            <button class="nav-btn" data-page="page2">üìä Tabel Data</button>
            <button class="nav-btn" data-page="page3">‚úèÔ∏è Update Data</button>
        </div>

        <!-- Pages Content -->
        <div class="pages">
            <!-- PAGE 1: PETA -->
            <div id="page1" class="page active">
                <div class="map-controls">
                    <input type="text" id="searchLocation" placeholder="Cari lokasi peralatan...">
                    <button onclick="searchLocation()">üîç Cari</button>
                    <button onclick="resetMap()">üîÑ Reset</button>
                    <button onclick="downloadData()">‚¨áÔ∏è Download CSV</button>
                </div>

                <div class="map-page-wrapper">
                    <!-- Sidebar -->
                    <div class="map-sidebar" id="mapSidebar">
                        <div class="sidebar-header">
                            <span>Pilihan Layer</span>
                            <button onclick="toggleSidebar()" title="Tutup">‚àí</button>
                        </div>
                        <div class="sidebar-content">
                            <!-- Observasi Udara Atas -->
                            <div class="layer-group">
                                <div class="layer-group-title" onclick="toggleLayerGroup(this)">
                                    <span class="toggle-icon">‚ñº</span>
                                    Observasi Udara Atas
                                </div>
                                <div class="layer-items show">
                                    <div class="layer-item">
                                        <input type="checkbox" id="layer-theodolite" class="layer-checkbox" data-layer="theodolite">
                                        <label for="layer-theodolite">Theodolite</label>
                                    </div>
                                    <div class="layer-item">
                                        <input type="checkbox" id="layer-tabung-gas" class="layer-checkbox" data-layer="tabung-gas">
                                        <label for="layer-tabung-gas">Tabung Gas</label>
                                    </div>
                                    <div class="layer-item">
                                        <input type="checkbox" id="layer-kop-gas" class="layer-checkbox" data-layer="kop-gas">
                                        <label for="layer-kop-gas">Kop Gas</label>
                                    </div>
                                    <div class="layer-item">
                                        <input type="checkbox" id="layer-ground-eq" class="layer-checkbox" data-layer="ground-equipment">
                                        <label for="layer-ground-eq">Ground Equipment</label>
                                    </div>
                                </div>
                            </div>

                            <!-- AWOS -->
                            <div class="layer-group">
                                <div class="layer-group-title" onclick="toggleLayerGroup(this)">
                                    <span class="toggle-icon">‚ñº</span>
                                    AWOS
                                </div>
                                <div class="layer-items show">
                                    <div class="layer-item">
                                        <input type="checkbox" id="layer-awos-1" class="layer-checkbox" data-layer="awos-kategori-1">
                                        <label for="layer-awos-1">Kategori 1</label>
                                    </div>
                                    <div class="layer-item">
                                        <input type="checkbox" id="layer-awos-2" class="layer-checkbox" data-layer="awos-kategori-2">
                                        <label for="layer-awos-2">Kategori 2</label>
                                    </div>
                                    <div class="layer-item">
                                        <input type="checkbox" id="layer-awos-3" class="layer-checkbox" data-layer="awos-kategori-3">
                                        <label for="layer-awos-3">Kategori 3</label>
                                    </div>
                                </div>
                            </div>

                            <!-- Wind Profiler -->
                            <div class="layer-group">
                                <div class="layer-group-title" onclick="toggleLayerGroup(this)">
                                    <span class="toggle-icon">‚ñº</span>
                                    Wind Profiler
                                </div>
                                <div class="layer-items show">
                                    <div class="layer-item">
                                        <input type="checkbox" id="layer-wind-profiler" class="layer-checkbox" data-layer="wind-profiler">
                                        <label for="layer-wind-profiler">Wind Profiler</label>
                                    </div>
                                </div>
                            </div>

                            <!-- LLWAS -->
                            <div class="layer-group">
                                <div class="layer-group-title" onclick="toggleLayerGroup(this)">
                                    <span class="toggle-icon">‚ñº</span>
                                    LLWAS
                                </div>
                                <div class="layer-items show">
                                    <div class="layer-item">
                                        <input type="checkbox" id="layer-llwas" class="layer-checkbox" data-layer="llwas">
                                        <label for="layer-llwas">LLWAS</label>
                                    </div>
                                </div>
                            </div>

                            <!-- Wind Shear Detection -->
                            <div class="layer-group">
                                <div class="layer-group-title" onclick="toggleLayerGroup(this)">
                                    <span class="toggle-icon">‚ñº</span>
                                    Wind Shear Detection
                                </div>
                                <div class="layer-items show">
                                    <div class="layer-item">
                                        <input type="checkbox" id="layer-wind-shear" class="layer-checkbox" data-layer="wind-shear-detection">
                                        <label for="layer-wind-shear">Wind Shear Detector</label>
                                    </div>
                                </div>
                            </div>

                            <!-- AWS Digitalisasi -->
                            <div class="layer-group">
                                <div class="layer-group-title" onclick="toggleLayerGroup(this)">
                                    <span class="toggle-icon">‚ñº</span>
                                    AWS Digitalisasi
                                </div>
                                <div class="layer-items show">
                                    <div class="layer-item">
                                        <input type="checkbox" id="layer-aws-dig" class="layer-checkbox" data-layer="aws-digitalisasi">
                                        <label for="layer-aws-dig">AWS Digitalisasi</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Toggle Sidebar Button -->
                    <button class="toggle-sidebar-btn" onclick="toggleSidebar()" title="Buka/Tutup Sidebar">‚â°</button>

                    <!-- Map Container -->
                    <div id="mapContainer"></div>

                    <!-- Map Top-Right Controls -->
                    <div class="map-top-right-controls">
                        <button class="map-control-btn" onclick="zoomMapIn()" title="Zoom In">+</button>
                        <button class="map-control-btn" onclick="zoomMapOut()" title="Zoom Out">‚àí</button>
                        <button class="map-control-btn" onclick="toggleMapFullscreen()" title="Fullscreen">‚õ∂</button>
                    </div>

                    <!-- Map Popup -->
                    <div class="map-popup" id="mapPopup">
                        <div class="map-popup-header">
                            <div class="map-popup-title" id="popupTitle">Nama Lokasi</div>
                            <button class="map-popup-close" onclick="closePopup()">‚úï</button>
                        </div>
                        <div class="map-popup-content" id="popupContent">
                            <!-- Content will be filled by JavaScript -->
                        </div>
                    </div>

                    <!-- Detail Popup (Kendala Operasional) -->
                    <div class="detail-popup" id="detailPopup">
                        <div class="detail-popup-header">
                            <div class="detail-popup-title" id="detailPopupTitle">Kendala Operasional</div>
                            <button class="detail-popup-close" onclick="closeDetailPopup()">‚úï</button>
                        </div>
                        <div class="detail-popup-content" id="detailPopupContent">
                            <!-- Content will be filled by JavaScript -->
                        </div>
                    </div>

                    <!-- Map Legend -->
                    <div class="map-legend" id="mapLegend">
                        <div class="map-legend-title">Keterangan</div>
                        <div class="map-legend-item">
                            <div class="map-legend-color green"></div>
                            <span class="map-legend-label">Peralatan Baik</span>
                        </div>
                        <div class="map-legend-item">
                            <div class="map-legend-color yellow"></div>
                            <span class="map-legend-label">Rusak Ringan</span>
                        </div>
                        <div class="map-legend-item">
                            <div class="map-legend-color red"></div>
                            <span class="map-legend-label">Rusak Berat</span>
                        </div>
                        <div class="map-legend-item">
                            <div class="map-legend-color black"></div>
                            <span class="map-legend-label">Data Kosong</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PAGE 2: METADATA -->
            <div id="page2" class="page">
                <div class="metadata-content">
                    <h2>Data Peralatan Meteorologi</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>Total Peralatan</h3>
                            <div class="value" id="totalData">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Lokasi Unik</h3>
                            <div class="value" id="uniqueLocations">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Update Terakhir</h3>
                            <div class="value" id="lastUpdate">-</div>
                        </div>
                    </div>

                    <div class="search-box">
                        <input type="text" id="tableSearch" placeholder="Cari data peralatan...">
                    </div>

                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Nama Lokasi</th>
                                <th>Latitude</th>
                                <th>Longitude</th>
                                <th>Deskripsi</th>
                                <th>Tanggal</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody">
                            <!-- Data akan diisi oleh JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- PAGE 3: UPDATE DATA -->
            <div id="page3" class="page">
                <div class="form-container">
                    <h2>Tambah/Update Data Peralatan</h2>
                    
                    <div id="message" class="message"></div>

                    <form id="dataForm">
                        <div class="form-group">
                            <label for="namaLokasi">Nama Lokasi Peralatan *</label>
                            <input type="text" id="namaLokasi" placeholder="Contoh: Stasiun Meteorologi Jakarta" required>
                        </div>

                        <div class="form-group">
                            <label for="latitude">Latitude *</label>
                            <input type="number" id="latitude" step="0.000001" placeholder="Contoh: -6.1754" required>
                        </div>

                        <div class="form-group">
                            <label for="longitude">Longitude *</label>
                            <input type="number" id="longitude" step="0.000001" placeholder="Contoh: 106.8272" required>
                        </div>

                        <div class="form-group">
                            <label for="deskripsi">Deskripsi Peralatan</label>
                            <textarea id="deskripsi" placeholder="Masukkan deskripsi jenis dan kondisi peralatan..."></textarea>
                        </div>

                        <div class="form-group">
                            <label for="kategori">Kategori Peralatan</label>
                            <select id="kategori">
                                <option value="">-- Pilih Kategori --</option>
                                <option value="Synoptic">Synoptic</option>
                                <option value="Aerodrome">Aerodrome</option>
                                <option value="AWOS">AWOS</option>
                                <option value="Weather Profiler">Weather Profiler</option>
                                <option value="LIDAR">LIDAR</option>
                                <option value="Wind Shear Detector">Wind Shear Detector</option>
                                <option value="AWS Digitalisasi">AWS Digitalisasi</option>
                                <option value="Lainnya">Lainnya</option>
                            </select>
                        </div>

                        <div class="button-group">
                            <button type="submit" class="btn btn-primary">üíæ Simpan Data</button>
                            <button type="reset" class="btn btn-secondary">üîÑ Reset Form</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS untuk Peta -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

    <script>
        // ==================== KONFIGURASI ====================
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTRQ49PvuPoXJpEFiIt2nZ5lmQoiKB6TyVegg2tayy3uGTjNDtrsH3UgDdZCZ5IZoLiIrS3QAYDdJud/pub?gid=1559156266&single=true&output=csv';
        const AWOS_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSklnMmMTXx-NHAqUjv30lXUMr5ihquxeH9Ti701Z6HjIIjWuChlt2YYU8iIULrX_kxuMzKjxLYzAw3/pub?gid=0&single=true&output=csv';
        const WIND_PROFILER_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSklnMmMTXx-NHAqUjv30lXUMr5ihquxeH9Ti701Z6HjIIjWuChlt2YYU8iIULrX_kxuMzKjxLYzAw3/pub?gid=102182381&single=true&output=csv';
        const LLWAS_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSklnMmMTXx-NHAqUjv30lXUMr5ihquxeH9Ti701Z6HjIIjWuChlt2YYU8iIULrX_kxuMzKjxLYzAw3/pub?gid=1288890081&single=true&output=csv';
        const WINDSHEAR_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSklnMmMTXx-NHAqUjv30lXUMr5ihquxeH9Ti701Z6HjIIjWuChlt2YYU8iIULrX_kxuMzKjxLYzAw3/pub?gid=58747578&single=true&output=csv';
        const AWS_DIGITAL_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSklnMmMTXx-NHAqUjv30lXUMr5ihquxeH9Ti701Z6HjIIjWuChlt2YYU8iIULrX_kxuMzKjxLYzAw3/pub?gid=1241381321&single=true&output=csv';
        
        // Data penyimpanan lokal (jika tidak menggunakan Google Sheets)
        let dataPoints = [];
        let allObservasiUdataAtasData = [];
        let allAwosData = [];
        let allWindProfilerData = [];
        let allLLWASData = [];
        let allWindshearData = [];
        let allAwsDigitalData = [];
        let map;
        let currentPopupMarker = null;
        let markers = [];
        let currentActiveLayer = null; // Untuk Observasi Udara Atas (mutually exclusive)
        let activeAwosLayers = new Set(); // Untuk AWOS (dapat overlapping)
        let windProfilerActive = false; // Untuk Wind Profiler
        let llwasActive = false; // Untuk LLWAS
        let windshearActive = false; // Untuk Windshear Detection
        let awsDigitalActive = false; // Untuk AWS Digital

        // ==================== INISIALISASI ====================
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            loadObservasiUdataAtasData();
            loadAwosData();
            loadWindProfilerData();
            loadLLWASData();
            loadWindshearData();
            loadAwsDigitalData();
            setupLayerCheckboxes();
            
            // Test: Add debug function to window for manual testing
            window.debugTest = function() {
                console.log('=== DEBUG TEST ===');
                console.log('currentActiveLayer:', currentActiveLayer);
                console.log('allObservasiUdataAtasData length:', allObservasiUdataAtasData.length);
                console.log('map object:', map);
                console.log('markers array length:', markers.length);
                if (allObservasiUdataAtasData.length > 0) {
                    console.log('First record:', allObservasiUdataAtasData[0]);
                }
                // Manually try to load theodolite
                console.log('Attempting to manually load theodolite...');
                currentActiveLayer = 'theodolite';
                addMarkersToMap();
            };
            console.log('Type "debugTest()" in console to run debug');
        });

        // ==================== FETCH DATA ====================
        async function loadObservasiUdataAtasData() {
            try {
                const response = await fetch(CSV_URL);
                const csvText = await response.text();
                allObservasiUdataAtasData = parseCSV(csvText);
                
                console.log('Data loaded:', allObservasiUdataAtasData);
                console.log('Total records:', allObservasiUdataAtasData.length);
                if (allObservasiUdataAtasData.length > 0) {
                    console.log('First record:', allObservasiUdataAtasData[0]);
                }
                
                // Add to dataPoints
                dataPoints = allObservasiUdataAtasData;
                
                // Jangan load default layer - tunggu user memilih
                // addMarkersToMap();
                updateMetadata();
            } catch (error) {
                console.error('Error loading data:', error);
                alert('Gagal memuat data. Pastikan URL spreadsheet benar.');
            }
        }

        async function loadAwosData() {
            try {
                const response = await fetch(AWOS_CSV_URL);
                const csvText = await response.text();
                allAwosData = parseCSV(csvText);
                
                console.log('AWOS Data loaded:', allAwosData);
                console.log('Total AWOS records:', allAwosData.length);
                if (allAwosData.length > 0) {
                    console.log('First AWOS record:', allAwosData[0]);
                    console.log('Column names:', Object.keys(allAwosData[0]));
                    
                    // Debug merk and tahun fields
                    const firstRecord = allAwosData[0];
                    console.log('=== DEBUGGING MERK & TAHUN ===');
                    Object.keys(firstRecord).forEach(key => {
                        if (key.toLowerCase().includes('merk') || key.toLowerCase().includes('tahun') || key.toLowerCase().includes('brand')) {
                            console.log(`Field: "${key}" = "${firstRecord[key]}"`);
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading AWOS data:', error);
            }
        }

        async function loadWindProfilerData() {
            try {
                const response = await fetch(WIND_PROFILER_CSV_URL);
                const csvText = await response.text();
                allWindProfilerData = parseCSV(csvText);
                
                console.log('Wind Profiler Data loaded:', allWindProfilerData);
                console.log('Total Wind Profiler records:', allWindProfilerData.length);
                if (allWindProfilerData.length > 0) {
                    console.log('First Wind Profiler record:', allWindProfilerData[0]);
                    console.log('Column names:', Object.keys(allWindProfilerData[0]));
                }
            } catch (error) {
                console.error('Error loading Wind Profiler data:', error);
            }
        }

        async function loadLLWASData() {
            try {
                const response = await fetch(LLWAS_CSV_URL);
                const csvText = await response.text();
                allLLWASData = parseCSV(csvText);
                
                console.log('LLWAS Data loaded:', allLLWASData);
                console.log('Total LLWAS records:', allLLWASData.length);
                if (allLLWASData.length > 0) {
                    console.log('First LLWAS record:', allLLWASData[0]);
                    console.log('Column names:', Object.keys(allLLWASData[0]));
                }
            } catch (error) {
                console.error('Error loading LLWAS data:', error);
            }
        }

        async function loadWindshearData() {
            try {
                const response = await fetch(WINDSHEAR_CSV_URL);
                const csvText = await response.text();
                allWindshearData = parseCSV(csvText);
                
                console.log('Windshear Data loaded:', allWindshearData);
                console.log('Total Windshear records:', allWindshearData.length);
                if (allWindshearData.length > 0) {
                    console.log('First Windshear record:', allWindshearData[0]);
                    console.log('Column names:', Object.keys(allWindshearData[0]));
                }
            } catch (error) {
                console.error('Error loading Windshear data:', error);
            }
        }

        async function loadAwsDigitalData() {
            try {
                const response = await fetch(AWS_DIGITAL_CSV_URL);
                const csvText = await response.text();
                allAwsDigitalData = parseCSV(csvText);
                
                console.log('AWS Digital Data loaded:', allAwsDigitalData);
                console.log('Total AWS Digital records:', allAwsDigitalData.length);
                if (allAwsDigitalData.length > 0) {
                    console.log('First AWS Digital record:', allAwsDigitalData[0]);
                    console.log('Column names:', Object.keys(allAwsDigitalData[0]));
                }
            } catch (error) {
                console.error('Error loading AWS Digital data:', error);
            }
        }

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                // Simple CSV parser - split by comma and trim
                const values = lines[i].split(',').map(v => v.trim().replace(/^"|"$/g, ''));
                const row = {};
                
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });
                
                // Only add rows with valid LAT/LON - support both "LAT"/"LON" and "Lat"/"Lon"
                const lat = parseFloat(row['LAT'] || row['Lat']);
                const lon = parseFloat(row['LON'] || row['Lon']);
                if (!isNaN(lat) && !isNaN(lon)) {
                    data.push(row);
                    if (data.length <= 3) {
                        console.log(`Row ${i} parsed:`, {
                            Stasiun: row['Stasiun'],
                            LAT: row['LAT'] || row['Lat'],
                            LON: row['LON'] || row['Lon']
                        });
                    }
                }
            }

            return data;
        }

        // ==================== PETA ====================
        function initMap() {
            map = L.map('mapContainer', {
                zoomControl: false
            }).setView([-2.5, 113.5], 5);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            // Test marker for debugging
            L.marker([0, 0], {
                icon: L.divIcon({
                    html: '<div style="width: 10px; height: 10px; background: purple; border: 2px solid white; border-radius: 50%;"></div>',
                    iconSize: [14, 14]
                })
            }).addTo(map).bindPopup('Test marker at 0,0 - Peta sedang aktif');

            // Close popup when clicking outside
            map.on('click', function(e) {
                if (e.originalEvent.target !== document.getElementById('mapPopup')) {
                    closePopup();
                }
            });
        }

        // ==================== HELPER FUNCTIONS ====================
        function determineMarkerColor(row, equipmentType) {
            if (equipmentType === 'theodolite') {
                const tb = row['TB'] ? parseInt(row['TB']) : 0;
                const tr = row['TR'] ? parseInt(row['TR']) : 0;
                const trb = row['TRB'] ? parseInt(row['TRB']) : 0;

                if (tb > 0) return '#2ecc71'; // Hijau - ada yang baik
                if (tr > 0) return '#f39c12'; // Kuning - ada yang rusak ringan
                if (trb > 0) return '#e74c3c'; // Merah - ada yang rusak berat
                return '#2c3e50'; // Hitam - kosong
            } else if (equipmentType === 'tabung-gas') {
                const condition = row['KTG'] ? row['KTG'].trim() : '';
                if (condition === 'Baik') return '#2ecc71'; // Hijau
                if (condition === 'Rusak' || condition === 'Isi ulang') return '#f39c12'; // Kuning
                if (condition === 'Rusak Berat') return '#e74c3c'; // Merah
                return '#2c3e50'; // Hitam - kosong
            } else if (equipmentType === 'kop-gas') {
                const condition = row['KKG'] ? row['KKG'].trim() : '';
                if (condition === 'Baik') return '#2ecc71'; // Hijau
                if (condition === 'Rusak ringan' || condition === 'Isi ulang') return '#f39c12'; // Kuning
                if (condition === 'Rusak Berat') return '#e74c3c'; // Merah
                return '#2c3e50'; // Hitam - kosong
            } else if (equipmentType === 'ground-equipment') {
                const condition = row['KGE'] ? row['KGE'].trim() : '';
                if (condition === 'Baik') return '#2ecc71'; // Hijau
                if (condition === 'Rusak') return '#f39c12'; // Kuning
                if (condition === 'Rusak Berat') return '#e74c3c'; // Merah
                return '#2c3e50'; // Hitam - kosong
            }
            return '#2c3e50';
        }

        function determineAwosColor(row) {
            // Determine highest kategori at this station from ACTIVE layers only
            // Prioritas: 3 > 2 > 1 (tapi hanya antara yang aktif)
            const awos3Active = activeAwosLayers.has('awos-kategori-3') && row['AWOS3'] && row['AWOS3'].trim() !== '';
            const awos2Active = activeAwosLayers.has('awos-kategori-2') && row['AWOS2'] && row['AWOS2'].trim() !== '';
            const awos1Active = activeAwosLayers.has('awos-kategori-1') && row['AWOS1'] && row['AWOS1'].trim() !== '';

            if (awos3Active) return '#9b59b6'; // Ungu - kategori 3
            if (awos2Active) return '#e8b4d4'; // Pink-biru gradasi - kategori 2
            if (awos1Active) return '#ff00ff'; // Magenta (merah tua) - kategori 1
            return '#2c3e50'; // Hitam - kosong
        }

        function getWindProfilerColor() {
            return '#00bcd4'; // Cyan/Turquoise - untuk Wind Profiler
        }

        function getLLWASColor() {
            return '#e67e22'; // Orange - untuk LLWAS
        }

        function getWindshearColor() {
            return '#c0392b'; // Deep Red - untuk Windshear Detection
        }

        function getAwsDigitalColor() {
            return '#16a085'; // Teal - untuk AWS Digital
        }

        function addMarkersToMap() {
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            // Cek apakah ada layer aktif (Observasi Udara Atas, AWOS, Wind Profiler, LLWAS, Windshear, atau AWS Digital)
            const hasObservasiLayer = currentActiveLayer !== null;
            const hasAwosLayers = activeAwosLayers.size > 0;

            if (!hasObservasiLayer && !hasAwosLayers && !windProfilerActive && !llwasActive && !windshearActive && !awsDigitalActive) {
                console.log('[addMarkersToMap] No active layer, markers cleared');
                return;
            }

            // ========== OBSERVASI UDARA ATAS MARKERS ==========
            if (hasObservasiLayer) {
                console.log('[addMarkersToMap] Adding Observasi Udara Atas markers for:', currentActiveLayer);
                console.log('[addMarkersToMap] Total data count:', allObservasiUdataAtasData.length);

                // Filter data berdasarkan active layer - HANYA tampilkan jika equipment punya data
                const filteredData = allObservasiUdataAtasData.filter(row => {
                    const lat = parseFloat(row['LAT']);
                    const lon = parseFloat(row['LON']);
                    const hasCoords = !isNaN(lat) && !isNaN(lon);
                    
                    if (!hasCoords) return false;
                    
                    // Check if this equipment has data for this station
                    if (currentActiveLayer === 'theodolite') {
                        const tb = row['TB'] ? parseInt(row['TB']) : 0;
                        const tr = row['TR'] ? parseInt(row['TR']) : 0;
                        const trb = row['TRB'] ? parseInt(row['TRB']) : 0;
                        return tb > 0 || tr > 0 || trb > 0;
                    } else if (currentActiveLayer === 'tabung-gas') {
                        return row['KTG'] && row['KTG'].trim() !== '';
                    } else if (currentActiveLayer === 'kop-gas') {
                        return row['KKG'] && row['KKG'].trim() !== '';
                    } else if (currentActiveLayer === 'ground-equipment') {
                        return row['KGE'] && row['KGE'].trim() !== '';
                    }
                    
                    return true;
                });

                console.log(`[addMarkersToMap] Observasi: ${filteredData.length} rows with valid equipment data`);

                filteredData.forEach(row => {
                    const lat = parseFloat(row['LAT']);
                    const lon = parseFloat(row['LON']);
                    const color = determineMarkerColor(row, currentActiveLayer);

                    const markerHTML = `<div style="width: 16px; height: 16px; background: ${color}; border: 3px solid white; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.3); cursor: pointer;"></div>`;

                    const marker = L.marker([lat, lon], {
                        icon: L.divIcon({
                            html: markerHTML,
                            iconSize: [22, 22],
                            className: 'leaflet-custom-marker'
                        })
                    }).addTo(map);

                    marker.data = row;
                    marker.type = 'observasi';
                    marker.on('click', function() {
                        showPopup(row, marker, 'observasi');
                    });

                    markers.push(marker);
                });
            }

            // ========== AWOS MARKERS ==========
            if (hasAwosLayers) {
                console.log('[addMarkersToMap] Adding AWOS markers for layers:', Array.from(activeAwosLayers));
                console.log('[addMarkersToMap] Total AWOS data count:', allAwosData.length);
                
                // Debug AWOS1 if active
                if (activeAwosLayers.has('awos-kategori-1')) {
                    const awos1Count = allAwosData.filter(row => row['AWOS1'] && row['AWOS1'].trim() !== '').length;
                    console.log('[DEBUG AWOS1] Total stations with AWOS1 data:', awos1Count);
                    const awos1Samples = allAwosData.filter(row => row['AWOS1'] && row['AWOS1'].trim() !== '').slice(0, 3);
                    console.log('[DEBUG AWOS1] Sample records with AWOS1:', awos1Samples);
                    awos1Samples.forEach((row, idx) => {
                        console.log(`[DEBUG AWOS1] Sample ${idx}:`, {
                            Lat: row['Lat'],
                            Lon: row['Lon'],
                            AWOS1: row['AWOS1'],
                            AWOS2: row['AWOS2'],
                            AWOS3: row['AWOS3'],
                            Stasiun: row['Stasiun']
                        });
                    });
                }

                // Build map for markers by coordinates to handle overlapping
                const markersByCoords = {};

                // Filter AWOS data based on active layers
                const filteredAwosData = allAwosData.filter(row => {
                    const lat = parseFloat(row['Lat']);
                    const lon = parseFloat(row['Lon']);
                    const hasCoords = !isNaN(lat) && !isNaN(lon);
                    
                    if (!hasCoords) return false;
                    
                    // Check if this station has any active AWOS kategori
                    const hasAwos1 = row['AWOS1'] && row['AWOS1'].trim() !== '' && activeAwosLayers.has('awos-kategori-1');
                    const hasAwos2 = row['AWOS2'] && row['AWOS2'].trim() !== '' && activeAwosLayers.has('awos-kategori-2');
                    const hasAwos3 = row['AWOS3'] && row['AWOS3'].trim() !== '' && activeAwosLayers.has('awos-kategori-3');
                    
                    return hasAwos1 || hasAwos2 || hasAwos3;
                });

                console.log(`[addMarkersToMap] AWOS: ${filteredAwosData.length} rows with valid kategori data`);

                filteredAwosData.forEach(row => {
                    const lat = parseFloat(row['Lat']);
                    const lon = parseFloat(row['Lon']);
                    const coordKey = `${lat.toFixed(6)},${lon.toFixed(6)}`;
                    
                    // Check if any active layer applies to this station
                    const hasActiveLayer = 
                        (row['AWOS1'] && row['AWOS1'].trim() !== '' && activeAwosLayers.has('awos-kategori-1')) ||
                        (row['AWOS2'] && row['AWOS2'].trim() !== '' && activeAwosLayers.has('awos-kategori-2')) ||
                        (row['AWOS3'] && row['AWOS3'].trim() !== '' && activeAwosLayers.has('awos-kategori-3'));
                    
                    if (!hasActiveLayer) return;
                    
                    // Store/update marker by coordinate to show highest kategori
                    const highestKat = getHighestAwosKategori(row);
                    if (!markersByCoords[coordKey]) {
                        markersByCoords[coordKey] = { row: row, lat: lat, lon: lon, kategori: highestKat };
                    } else {
                        const existingKat = getHighestAwosKategori(markersByCoords[coordKey].row);
                        if (highestKat > existingKat) {
                            markersByCoords[coordKey] = { row: row, lat: lat, lon: lon, kategori: highestKat };
                        }
                    }
                });

                // Create markers from deduplicated data
                Object.values(markersByCoords).forEach(item => {
                    const color = determineAwosColor(item.row);
                    const markerHTML = `<div style="width: 16px; height: 16px; background: ${color}; border: 3px solid white; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.3); cursor: pointer;"></div>`;

                    const marker = L.marker([item.lat, item.lon], {
                        icon: L.divIcon({
                            html: markerHTML,
                            iconSize: [22, 22],
                            className: 'leaflet-custom-marker'
                        })
                    }).addTo(map);

                    marker.data = item.row;
                    marker.type = 'awos';
                    marker.on('click', function() {
                        showPopup(item.row, marker, 'awos');
                    });

                    markers.push(marker);
                });
            }

            // ========== WIND PROFILER MARKERS ==========
            if (windProfilerActive) {
                console.log('[addMarkersToMap] Adding Wind Profiler markers');
                console.log('[addMarkersToMap] Total Wind Profiler data count:', allWindProfilerData.length);

                // Filter Wind Profiler data - hanya yang punya data Wind_Profiler
                const filteredWindProfilerData = allWindProfilerData.filter(row => {
                    const lat = parseFloat(row['Lat']);
                    const lon = parseFloat(row['Lon']);
                    const hasCoords = !isNaN(lat) && !isNaN(lon);
                    
                    if (!hasCoords) return false;
                    
                    // Only show if Wind_Profiler column has data
                    return row['Wind_Profiler'] && row['Wind_Profiler'].trim() !== '';
                });

                console.log(`[addMarkersToMap] Wind Profiler: ${filteredWindProfilerData.length} rows with valid data`);

                filteredWindProfilerData.forEach(row => {
                    const lat = parseFloat(row['Lat']);
                    const lon = parseFloat(row['Lon']);
                    const color = getWindProfilerColor();

                    const markerHTML = `<div style="width: 16px; height: 16px; background: ${color}; border: 3px solid white; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.3); cursor: pointer;"></div>`;

                    const marker = L.marker([lat, lon], {
                        icon: L.divIcon({
                            html: markerHTML,
                            iconSize: [22, 22],
                            className: 'leaflet-custom-marker'
                        })
                    }).addTo(map);

                    marker.data = row;
                    marker.type = 'wind-profiler';
                    marker.on('click', function() {
                        showPopup(row, marker, 'wind-profiler');
                    });

                    markers.push(marker);
                });
            }

            // ========== LLWAS MARKERS ==========
            if (llwasActive) {
                console.log('[addMarkersToMap] Adding LLWAS markers');
                console.log('[addMarkersToMap] Total LLWAS data count:', allLLWASData.length);

                // Filter LLWAS data - hanya yang punya data LLWAS
                const filteredLLWASData = allLLWASData.filter(row => {
                    const lat = parseFloat(row['Lat']);
                    const lon = parseFloat(row['Lon']);
                    const hasCoords = !isNaN(lat) && !isNaN(lon);
                    
                    if (!hasCoords) return false;
                    
                    // Only show if LLWAS column has data
                    return row['LLWAS'] && row['LLWAS'].trim() !== '';
                });

                console.log(`[addMarkersToMap] LLWAS: ${filteredLLWASData.length} rows with valid data`);

                filteredLLWASData.forEach(row => {
                    const lat = parseFloat(row['Lat']);
                    const lon = parseFloat(row['Lon']);
                    const color = getLLWASColor();

                    const markerHTML = `<div style="width: 16px; height: 16px; background: ${color}; border: 3px solid white; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.3); cursor: pointer;"></div>`;

                    const marker = L.marker([lat, lon], {
                        icon: L.divIcon({
                            html: markerHTML,
                            iconSize: [22, 22],
                            className: 'leaflet-custom-marker'
                        })
                    }).addTo(map);

                    marker.data = row;
                    marker.type = 'llwas';
                    marker.on('click', function() {
                        showPopup(row, marker, 'llwas');
                    });

                    markers.push(marker);
                });
            }

            // ========== WINDSHEAR DETECTION MARKERS ==========
            if (windshearActive) {
                console.log('[addMarkersToMap] Adding Windshear Detection markers');
                console.log('[addMarkersToMap] Total Windshear data count:', allWindshearData.length);

                // Filter Windshear data - hanya yang punya data Windshear
                const filteredWindshearData = allWindshearData.filter(row => {
                    const lat = parseFloat(row['Lat']);
                    const lon = parseFloat(row['Lon']);
                    const hasCoords = !isNaN(lat) && !isNaN(lon);
                    
                    if (!hasCoords) return false;
                    
                    // Only show if Windshear column has data
                    return row['Windshear'] && row['Windshear'].trim() !== '';
                });

                console.log(`[addMarkersToMap] Windshear: ${filteredWindshearData.length} rows with valid data`);

                filteredWindshearData.forEach(row => {
                    const lat = parseFloat(row['Lat']);
                    const lon = parseFloat(row['Lon']);
                    const color = getWindshearColor();

                    const markerHTML = `<div style="width: 16px; height: 16px; background: ${color}; border: 3px solid white; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.3); cursor: pointer;"></div>`;

                    const marker = L.marker([lat, lon], {
                        icon: L.divIcon({
                            html: markerHTML,
                            iconSize: [22, 22],
                            className: 'leaflet-custom-marker'
                        })
                    }).addTo(map);

                    marker.data = row;
                    marker.type = 'windshear';
                    marker.on('click', function() {
                        showPopup(row, marker, 'windshear');
                    });

                    markers.push(marker);
                });
            }

            // ========== AWS DIGITAL MARKERS ==========
            if (awsDigitalActive) {
                console.log('[addMarkersToMap] Adding AWS Digital markers');
                console.log('[addMarkersToMap] Total AWS Digital data count:', allAwsDigitalData.length);

                // Filter AWS Digital data - hanya yang punya data AWS_digi
                const filteredAwsDigitalData = allAwsDigitalData.filter(row => {
                    const lat = parseFloat(row['Lat']);
                    const lon = parseFloat(row['Lon']);
                    const hasCoords = !isNaN(lat) && !isNaN(lon);
                    
                    if (!hasCoords) return false;
                    
                    // Only show if AWS_digi column has data
                    return row['AWS_digi'] && row['AWS_digi'].trim() !== '';
                });

                console.log(`[addMarkersToMap] AWS Digital: ${filteredAwsDigitalData.length} rows with valid data`);

                filteredAwsDigitalData.forEach(row => {
                    const lat = parseFloat(row['Lat']);
                    const lon = parseFloat(row['Lon']);
                    const color = getAwsDigitalColor();

                    const markerHTML = `<div style="width: 16px; height: 16px; background: ${color}; border: 3px solid white; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.3); cursor: pointer;"></div>`;

                    const marker = L.marker([lat, lon], {
                        icon: L.divIcon({
                            html: markerHTML,
                            iconSize: [22, 22],
                            className: 'leaflet-custom-marker'
                        })
                    }).addTo(map);

                    marker.data = row;
                    marker.type = 'aws-digital';
                    marker.on('click', function() {
                        showPopup(row, marker, 'aws-digital');
                    });

                    markers.push(marker);
                });
            }

            console.log(`[addMarkersToMap] Total markers: ${markers.length}`);
        }

        function getHighestAwosKategori(row) {
            if (row['AWOS3'] && row['AWOS3'].trim() !== '') return 3;
            if (row['AWOS2'] && row['AWOS2'].trim() !== '') return 2;
            if (row['AWOS1'] && row['AWOS1'].trim() !== '') return 1;
            return 0;
        }

        // ==================== POPUP ====================
        function showPopup(row, marker, markerType = 'observasi') {
            const popup = document.getElementById('mapPopup');
            const title = document.getElementById('popupTitle');
            const content = document.getElementById('popupContent');

            let popupHTML = '';
            
            if (markerType === 'awos') {
                // AWOS Popup - display ALL active categories at this station
                title.textContent = `AWOS - ${row['ICAO'] || '-'}`;
                
                // Collect all ACTIVE categories that have data at this station
                const activeCategories = [];
                if (row['AWOS1'] && row['AWOS1'].trim() !== '' && activeAwosLayers.has('awos-kategori-1')) {
                    activeCategories.push(1);
                }
                if (row['AWOS2'] && row['AWOS2'].trim() !== '' && activeAwosLayers.has('awos-kategori-2')) {
                    activeCategories.push(2);
                }
                if (row['AWOS3'] && row['AWOS3'].trim() !== '' && activeAwosLayers.has('awos-kategori-3')) {
                    activeCategories.push(3);
                }
                
                // Build HTML for each active category
                let categoryHTML = '';
                activeCategories.forEach(kat => {
                    const awosData = row[`AWOS${kat}`];
                    const merkValue = row[`Merk${kat}`] || '-';
                    const tahunValue = row[`Tahun${kat}`] || '-';
                    
                    categoryHTML += `
                    <div class="map-popup-item">
                        <span class="map-popup-label">AWOS Kategori ${kat}:</span>
                        <span class="map-popup-value">${awosData || '-'}</span>
                    </div>
                    <div class="map-popup-item">
                        <span class="map-popup-label">Merk Kategori ${kat}:</span>
                        <span class="map-popup-value">${merkValue}</span>
                    </div>
                    <div class="map-popup-item">
                        <span class="map-popup-label">Tahun Kategori ${kat}:</span>
                        <span class="map-popup-value">${tahunValue}</span>
                    </div>
                    `;
                });
                
                popupHTML = `
                    <div class="map-popup-item">
                        <span class="map-popup-label">ICAO:</span>
                        <span class="map-popup-value">${row['ICAO'] || '-'}</span>
                    </div>
                    <div class="map-popup-item">
                        <span class="map-popup-label">Nama Stasiun:</span>
                        <span class="map-popup-value">${row['Stasiun'] || '-'}</span>
                    </div>
                    <div class="map-popup-item">
                        <span class="map-popup-label">Nama Bandara:</span>
                        <span class="map-popup-value">${row['Bandara'] || '-'}</span>
                    </div>
                    ${categoryHTML}
                    <div class="map-popup-item">
                        <span class="map-popup-label">Kalibrasi Terakhir:</span>
                        <span class="map-popup-value">${row['Kalibrasi'] || '-'}</span>
                    </div>
                    <div class="map-popup-item">
                        <span class="map-popup-label">Status Kalibrasi:</span>
                        <span class="map-popup-value">${row['Stastus_Kalibrasi'] || '-'}</span>
                    </div>
                    <div class="map-popup-item">
                        <span class="map-popup-label">Keterangan:</span>
                        <span class="map-popup-value">${row['Keterangan'] || '-'}</span>
                    </div>
                `;
            } else if (markerType === 'wind-profiler') {
                // Wind Profiler Popup
                title.textContent = `Wind Profiler - ${row['ICAO'] || '-'}`;
                
                popupHTML = `
                    <div class="map-popup-item">
                        <span class="map-popup-label">ICAO:</span>
                        <span class="map-popup-value">${row['ICAO'] || '-'}</span>
                    </div>
                    <div class="map-popup-item">
                        <span class="map-popup-label">Nama Stasiun:</span>
                        <span class="map-popup-value">${row['Stasiun'] || '-'}</span>
                    </div>
                    <div class="map-popup-item">
                        <span class="map-popup-label">Nama Bandara:</span>
                        <span class="map-popup-value">${row['Bandara'] || '-'}</span>
                    </div>
                    <div class="map-popup-item">
                        <span class="map-popup-label">Wind Profiler:</span>
                        <span class="map-popup-value">${row['Wind_Profiler'] || '-'}</span>
                    </div>
                    <div class="map-popup-item">
                        <span class="map-popup-label">Merk:</span>
                        <span class="map-popup-value">${row['Merk'] || '-'}</span>
                    </div>
                    <div class="map-popup-item">
                        <span class="map-popup-label">Tahun Pengadaan:</span>
                        <span class="map-popup-value">${row['Tahun'] || '-'}</span>
                    </div>
                    <div class="map-popup-item">
                        <span class="map-popup-label">Kalibrasi Terakhir:</span>
                        <span class="map-popup-value">${row['Kalibrasi'] || '-'}</span>
                    </div>
                    <div class="map-popup-item">
                        <span class="map-popup-label">Status Kalibrasi:</span>
                        <span class="map-popup-value">${row['Stastus_Kalibrasi'] || '-'}</span>
                    </div>
                    <div class="map-popup-item">
                        <span class="map-popup-label">Keterangan:</span>
                        <span class="map-popup-value">${row['Keterangan'] || '-'}</span>
                    </div>
                `;
            } else if (markerType === 'llwas') {
                // LLWAS Popup
                title.textContent = `LLWAS - ${row['ICAO'] || '-'}`;
                
                popupHTML = `
                    <div class="map-popup-item">
                        <span class="map-popup-label">ICAO:</span>
                        <span class="map-popup-value">${row['ICAO'] || '-'}</span>
                    </div>
                    <div class="map-popup-item">
                        <span class="map-popup-label">Nama Stasiun:</span>
                        <span class="map-popup-value">${row['Stasiun'] || '-'}</span>
                    </div>
                    <div class="map-popup-item">
                        <span class="map-popup-label">Nama Bandara:</span>
                        <span class="map-popup-value">${row['Bandara'] || '-'}</span>
                    </div>
                    <div class="map-popup-item">
                        <span class="map-popup-label">LLWAS:</span>
                        <span class="map-popup-value">${row['LLWAS'] || '-'}</span>
                    </div>
                    <div class="map-popup-item">
                        <span class="map-popup-label">Merk:</span>
                        <span class="map-popup-value">${row['Merk'] || '-'}</span>
                    </div>
                    <div class="map-popup-item">
                        <span class="map-popup-label">Tahun Pengadaan:</span>
                        <span class="map-popup-value">${row['Tahun'] || '-'}</span>
                    </div>
                    <div class="map-popup-item">
                        <span class="map-popup-label">Kalibrasi Terakhir:</span>
                        <span class="map-popup-value">${row['Kalibrasi'] || '-'}</span>
                    </div>
                    <div class="map-popup-item">
                        <span class="map-popup-label">Status Kalibrasi:</span>
                        <span class="map-popup-value">${row['Stastus_Kalibrasi'] || '-'}</span>
                    </div>
                    <div class="map-popup-item">
                        <span class="map-popup-label">Keterangan:</span>
                        <span class="map-popup-value">${row['Keterangan'] || '-'}</span>
                    </div>
                `;
            } else if (markerType === 'windshear') {
                // Windshear Detection Popup
                title.textContent = `Windshear Detection - ${row['ICAO'] || '-'}`;
                
                popupHTML = `
                    <div class="map-popup-item">
                        <span class="map-popup-label">ICAO:</span>
                        <span class="map-popup-value">${row['ICAO'] || '-'}</span>
                    </div>
                    <div class="map-popup-item">
                        <span class="map-popup-label">Nama Stasiun:</span>
                        <span class="map-popup-value">${row['Stasiun'] || '-'}</span>
                    </div>
                    <div class="map-popup-item">
                        <span class="map-popup-label">Nama Bandara:</span>
                        <span class="map-popup-value">${row['Bandara'] || '-'}</span>
                    </div>
                    <div class="map-popup-item">
                        <span class="map-popup-label">Windshear Detection:</span>
                        <span class="map-popup-value">${row['Windshear'] || '-'}</span>
                    </div>
                    <div class="map-popup-item">
                        <span class="map-popup-label">Merk:</span>
                        <span class="map-popup-value">${row['Merk'] || '-'}</span>
                    </div>
                    <div class="map-popup-item">
                        <span class="map-popup-label">Tahun Pengadaan:</span>
                        <span class="map-popup-value">${row['Tahun'] || '-'}</span>
                    </div>
                    <div class="map-popup-item">
                        <span class="map-popup-label">Kalibrasi Terakhir:</span>
                        <span class="map-popup-value">${row['Kalibrasi'] || '-'}</span>
                    </div>
                    <div class="map-popup-item">
                        <span class="map-popup-label">Status Kalibrasi:</span>
                        <span class="map-popup-value">${row['Stastus_Kalibrasi'] || '-'}</span>
                    </div>
                    <div class="map-popup-item">
                        <span class="map-popup-label">Keterangan:</span>
                        <span class="map-popup-value">${row['Keterangan'] || '-'}</span>
                    </div>
                `;
            } else if (markerType === 'aws-digital') {
                // AWS Digital Popup
                title.textContent = `AWS Digital - ${row['ICAO'] || '-'}`;
                
                popupHTML = `
                    <div class="map-popup-item">
                        <span class="map-popup-label">ICAO:</span>
                        <span class="map-popup-value">${row['ICAO'] || '-'}</span>
                    </div>
                    <div class="map-popup-item">
                        <span class="map-popup-label">Nama Stasiun:</span>
                        <span class="map-popup-value">${row['Stasiun'] || '-'}</span>
                    </div>
                    <div class="map-popup-item">
                        <span class="map-popup-label">Nama Bandara:</span>
                        <span class="map-popup-value">${row['Bandara'] || '-'}</span>
                    </div>
                    <div class="map-popup-item">
                        <span class="map-popup-label">AWS Digital:</span>
                        <span class="map-popup-value">${row['AWS_digi'] || '-'}</span>
                    </div>
                    <div class="map-popup-item">
                        <span class="map-popup-label">Merk:</span>
                        <span class="map-popup-value">${row['Merk'] || '-'}</span>
                    </div>
                    <div class="map-popup-item">
                        <span class="map-popup-label">Tahun Pengadaan:</span>
                        <span class="map-popup-value">${row['Tahun'] || '-'}</span>
                    </div>
                    <div class="map-popup-item">
                        <span class="map-popup-label">Kalibrasi Terakhir:</span>
                        <span class="map-popup-value">${row['Kalibrasi'] || '-'}</span>
                    </div>
                    <div class="map-popup-item">
                        <span class="map-popup-label">Status Kalibrasi:</span>
                        <span class="map-popup-value">${row['Stastus_Kalibrasi'] || '-'}</span>
                    </div>
                    <div class="map-popup-item">
                        <span class="map-popup-label">Keterangan:</span>
                        <span class="map-popup-value">${row['Keterangan'] || '-'}</span>
                    </div>
                `;
            } else {
                // Observasi Udara Atas Popup
                title.textContent = `${row['ID_Stasiun']} - ${row['Stasiun']}`;
                
                if (currentActiveLayer === 'theodolite') {
                    const tb = parseInt(row['TB']) || 0;
                    const tr = parseInt(row['TR']) || 0;
                    const trb = parseInt(row['TRB']) || 0;
                    
                    let theodoliteInfo = [];
                    if (tb > 0) theodoliteInfo.push(`${tb} Baik`);
                    if (tr > 0) theodoliteInfo.push(`${tr} Rusak`);
                    if (trb > 0) theodoliteInfo.push(`${trb} Rusak Berat`);
                    
                    popupHTML = `
                        <div class="map-popup-item">
                            <span class="map-popup-label">ID Stasiun:</span>
                            <span class="map-popup-value">${row['ID_Stasiun']}</span>
                        </div>
                        <div class="map-popup-item">
                            <span class="map-popup-label">Theodolite:</span>
                            <span class="map-popup-value">${theodoliteInfo.join(', ')}</span>
                        </div>
                        ${row['DKT'] ? `<div class="map-popup-item"><span class="map-popup-label">‚ÑπÔ∏è Info:</span><span class="map-popup-value">${row['DKT']}</span></div>` : ''}
                        ${row['kendala'] ? `<div class="map-popup-item"><span class="map-popup-label"><a href="#" onclick="showDetailPopup('${encodeURIComponent(row['kendala'])}', 'Kendala Operasional'); return false;" style="color: #0b5394; text-decoration: underline; cursor: pointer;">üîó Kendala Operasional</a></span></div>` : ''}
                        ${row['surat_T'] ? `<div class="map-popup-item"><span class="map-popup-label"><a href="${row['surat_T']}" target="_blank" style="color: #0b5394; text-decoration: underline; cursor: pointer;">üìÇ File Surat</a></span></div>` : ''}
                    `;
                } else if (currentActiveLayer === 'tabung-gas') {
                    popupHTML = `
                        <div class="map-popup-item">
                            <span class="map-popup-label">ID Stasiun:</span>
                            <span class="map-popup-value">${row['ID_Stasiun']}</span>
                        </div>
                        <div class="map-popup-item">
                            <span class="map-popup-label">Tabung Gas:</span>
                            <span class="map-popup-value">${row['KTG'] || '-'}</span>
                        </div>
                        <div class="map-popup-item">
                            <span class="map-popup-label">Tahun Pengadaan:</span>
                            <span class="map-popup-value">${row['t_TG'] || '-'}</span>
                        </div>
                        ${row['DKTG'] ? `<div class="map-popup-item"><span class="map-popup-label">‚ÑπÔ∏è Info:</span><span class="map-popup-value">${row['DKTG']}</span></div>` : ''}
                        <div class="map-popup-item">
                            <span class="map-popup-label">Jenis:</span>
                            <span class="map-popup-value">${row['JTG'] || '-'}</span>
                        </div>
                        ${row['kendala'] ? `<div class="map-popup-item"><span class="map-popup-label"><a href="#" onclick="showDetailPopup('${encodeURIComponent(row['kendala'])}', 'Kendala Operasional'); return false;" style="color: #0b5394; text-decoration: underline; cursor: pointer;">üîó Kendala Operasional</a></span></div>` : ''}
                        ${row['surat_TG'] ? `<div class="map-popup-item"><span class="map-popup-label"><a href="${row['surat_TG']}" target="_blank" style="color: #0b5394; text-decoration: underline; cursor: pointer;">üìÇ File Surat</a></span></div>` : ''}
                    `;
                } else if (currentActiveLayer === 'kop-gas') {
                    popupHTML = `
                        <div class="map-popup-item">
                            <span class="map-popup-label">ID Stasiun:</span>
                            <span class="map-popup-value">${row['ID_Stasiun']}</span>
                        </div>
                        <div class="map-popup-item">
                            <span class="map-popup-label">Kop Gas:</span>
                            <span class="map-popup-value">${row['KKG'] || '-'}</span>
                        </div>
                        <div class="map-popup-item">
                            <span class="map-popup-label">Tahun Pengadaan:</span>
                            <span class="map-popup-value">${row['t_KG'] || '-'}</span>
                        </div>
                        ${row['DKG'] ? `<div class="map-popup-item"><span class="map-popup-label">‚ÑπÔ∏è Info:</span><span class="map-popup-value">${row['DKG']}</span></div>` : ''}
                        ${row['kendala'] ? `<div class="map-popup-item"><span class="map-popup-label"><a href="#" onclick="showDetailPopup('${encodeURIComponent(row['kendala'])}', 'Kendala Operasional'); return false;" style="color: #0b5394; text-decoration: underline; cursor: pointer;">üîó Kendala Operasional</a></span></div>` : ''}
                        ${row['surat_KG'] ? `<div class="map-popup-item"><span class="map-popup-label"><a href="${row['surat_KG']}" target="_blank" style="color: #0b5394; text-decoration: underline; cursor: pointer;">üìÇ File Surat</a></span></div>` : ''}
                    `;
                } else if (currentActiveLayer === 'ground-equipment') {
                    popupHTML = `
                        <div class="map-popup-item">
                            <span class="map-popup-label">ID Stasiun:</span>
                            <span class="map-popup-value">${row['ID_Stasiun']}</span>
                        </div>
                        <div class="map-popup-item">
                            <span class="map-popup-label">Ground Equipment:</span>
                            <span class="map-popup-value">${row['GE'] || '-'}</span>
                        </div>
                        <div class="map-popup-item">
                            <span class="map-popup-label">Tahun Pengadaan:</span>
                            <span class="map-popup-value">${row['t_GE'] || '-'}</span>
                        </div>
                        ${row['DKGE'] ? `<div class="map-popup-item"><span class="map-popup-label">‚ÑπÔ∏è Info:</span><span class="map-popup-value">${row['DKGE']}</span></div>` : ''}
                        ${row['kendala'] ? `<div class="map-popup-item"><span class="map-popup-label"><a href="#" onclick="showDetailPopup('${encodeURIComponent(row['kendala'])}', 'Kendala Operasional'); return false;" style="color: #0b5394; text-decoration: underline; cursor: pointer;">üîó Kendala Operasional</a></span></div>` : ''}
                        ${row['surat_KG'] ? `<div class="map-popup-item"><span class="map-popup-label"><a href="${row['surat_KG']}" target="_blank" style="color: #0b5394; text-decoration: underline; cursor: pointer;">üìÇ File Surat</a></span></div>` : ''}
                    `;
                }
            }

            content.innerHTML = popupHTML;
            popup.classList.add('show');
            currentPopupMarker = marker;

            // Position popup near marker
            const markerPos = map.latLngToContainerPoint(marker.getLatLng());
            popup.style.left = (markerPos.x + 20) + 'px';
            popup.style.top = (markerPos.y - 50) + 'px';
        }

        function closePopup() {
            const popup = document.getElementById('mapPopup');
            popup.classList.remove('show');
            currentPopupMarker = null;
        }

        function showDetailPopup(content, title) {
            const detailPopup = document.getElementById('detailPopup');
            const detailTitle = document.getElementById('detailPopupTitle');
            const detailContent = document.getElementById('detailPopupContent');

            detailTitle.textContent = title;
            detailContent.innerHTML = `<p>${decodeURIComponent(content)}</p>`;
            detailPopup.classList.add('show');

            // Position near cursor or main popup
            const mainPopup = document.getElementById('mapPopup');
            if (mainPopup.classList.contains('show')) {
                const mainPos = mainPopup.getBoundingClientRect();
                detailPopup.style.left = (mainPos.right + 20) + 'px';
                detailPopup.style.top = mainPos.top + 'px';
            }
        }

        function closeDetailPopup() {
            const detailPopup = document.getElementById('detailPopup');
            detailPopup.classList.remove('show');
        }

        // ==================== MAP CONTROLS ====================
        function zoomMapIn() {
            map.zoomIn();
        }

        function zoomMapOut() {
            map.zoomOut();
        }

        function toggleMapFullscreen() {
            const mapContainer = document.getElementById('mapContainer');
            if (!document.fullscreenElement) {
                mapContainer.requestFullscreen().catch(err => {
                    alert('Error: ' + err.message);
                });
            } else {
                document.exitFullscreen();
            }
        }

        // ==================== SIDEBAR ====================
        function toggleSidebar() {
            const sidebar = document.getElementById('mapSidebar');
            sidebar.classList.toggle('hidden');
        }

        function toggleLayerGroup(element) {
            const icon = element.querySelector('.toggle-icon');
            const items = element.nextElementSibling;

            icon.classList.toggle('collapsed');
            items.classList.toggle('show');
        }

        function setupLayerCheckboxes() {
            console.log('Setting up layer checkboxes...');
            
            // Observasi Udara Atas - Mutually Exclusive
            const observasiCheckboxes = [
                'layer-theodolite',
                'layer-tabung-gas',
                'layer-kop-gas',
                'layer-ground-eq'
            ];

            observasiCheckboxes.forEach(checkboxId => {
                const checkbox = document.getElementById(checkboxId);
                console.log(`Checking checkbox ${checkboxId}:`, checkbox ? 'FOUND' : 'NOT FOUND');
                
                if (checkbox) {
                    checkbox.addEventListener('change', function() {
                        console.log(`[CHECKBOX CHANGE] ${checkboxId} changed, checked=${this.checked}`);
                        
                        if (this.checked) {
                            // Uncheck semua yang lain di group yang sama
                            observasiCheckboxes.forEach(otherId => {
                                if (otherId !== checkboxId) {
                                    document.getElementById(otherId).checked = false;
                                }
                            });

                            // Update active layer
                            const layerType = this.getAttribute('data-layer');
                            currentActiveLayer = layerType;
                            
                            console.log('[LAYER ACTIVATED] Layer aktif:', currentActiveLayer);
                            console.log('[DATA CHECK] Total data available:', allObservasiUdataAtasData.length);
                            if (allObservasiUdataAtasData.length > 0) {
                                console.log('[DATA SAMPLE] First record:', allObservasiUdataAtasData[0]);
                            }
                            
                            // Update peta
                            console.log('[ADDING MARKERS] Calling addMarkersToMap()...');
                            addMarkersToMap();
                            
                            // Show legenda
                            document.getElementById('mapLegend').classList.add('show');
                        } else {
                            // Jika unchecked, clear peta dan legenda
                            console.log('[LAYER DEACTIVATED] Clearing markers');
                            currentActiveLayer = null;
                            addMarkersToMap();
                            document.getElementById('mapLegend').classList.remove('show');
                        }
                    });
                } else {
                    console.warn(`Checkbox ${checkboxId} not found!`);
                }
            });
            
            console.log('Layer checkboxes setup completed');
            
            // ========== AWOS Layers - Non-Mutually Exclusive ==========
            const awosCheckboxes = [
                'layer-awos-1',
                'layer-awos-2',
                'layer-awos-3'
            ];
            
            awosCheckboxes.forEach(checkboxId => {
                const checkbox = document.getElementById(checkboxId);
                console.log(`Checking AWOS checkbox ${checkboxId}:`, checkbox ? 'FOUND' : 'NOT FOUND');
                
                if (checkbox) {
                    checkbox.addEventListener('change', function() {
                        const layerType = this.getAttribute('data-layer');
                        console.log(`[AWOS CHECKBOX] ${checkboxId} changed, checked=${this.checked}, layer=${layerType}`);
                        
                        if (this.checked) {
                            activeAwosLayers.add(layerType);
                            console.log('[AWOS LAYER ACTIVATED] Active AWOS layers:', Array.from(activeAwosLayers));
                        } else {
                            activeAwosLayers.delete(layerType);
                            console.log('[AWOS LAYER DEACTIVATED] Active AWOS layers:', Array.from(activeAwosLayers));
                        }
                        
                        // Update peta
                        console.log('[AWOS] Calling addMarkersToMap()...');
                        addMarkersToMap();
                        
                        // Show/hide legenda
                        if (activeAwosLayers.size > 0) {
                            document.getElementById('mapLegend').classList.add('show');
                        } else if (currentActiveLayer === null) {
                            // Hide legenda hanya jika tidak ada layer yang aktif
                            document.getElementById('mapLegend').classList.remove('show');
                        }
                    });
                } else {
                    console.warn(`AWOS Checkbox ${checkboxId} not found!`);
                }
            });

            // ========== WIND PROFILER LAYER ==========
            const windProfilerCheckbox = document.getElementById('layer-wind-profiler');
            console.log('Checking Wind Profiler checkbox:', windProfilerCheckbox ? 'FOUND' : 'NOT FOUND');
            
            if (windProfilerCheckbox) {
                windProfilerCheckbox.addEventListener('change', function() {
                    console.log(`[WIND PROFILER CHECKBOX] changed, checked=${this.checked}`);
                    
                    windProfilerActive = this.checked;
                    
                    // Update peta
                    console.log('[WIND PROFILER] Calling addMarkersToMap()...');
                    addMarkersToMap();
                    
                    // Show/hide legenda
                    if (windProfilerActive) {
                        document.getElementById('mapLegend').classList.add('show');
                    } else if (currentActiveLayer === null && activeAwosLayers.size === 0) {
                        // Hide legenda hanya jika tidak ada layer yang aktif
                        document.getElementById('mapLegend').classList.remove('show');
                    }
                });
            } else {
                console.warn('Wind Profiler Checkbox not found!');
            }

            // ========== LLWAS LAYER ==========
            const llwasCheckbox = document.getElementById('layer-llwas');
            console.log('Checking LLWAS checkbox:', llwasCheckbox ? 'FOUND' : 'NOT FOUND');
            
            if (llwasCheckbox) {
                llwasCheckbox.addEventListener('change', function() {
                    console.log(`[LLWAS CHECKBOX] changed, checked=${this.checked}`);
                    
                    llwasActive = this.checked;
                    
                    // Update peta
                    console.log('[LLWAS] Calling addMarkersToMap()...');
                    addMarkersToMap();
                    
                    // Show/hide legenda
                    if (llwasActive) {
                        document.getElementById('mapLegend').classList.add('show');
                    } else if (currentActiveLayer === null && activeAwosLayers.size === 0 && !windProfilerActive) {
                        // Hide legenda hanya jika tidak ada layer yang aktif
                        document.getElementById('mapLegend').classList.remove('show');
                    }
                });
            } else {
                console.warn('LLWAS Checkbox not found!');
            }

            // ========== WINDSHEAR DETECTION LAYER ==========
            const windshearCheckbox = document.getElementById('layer-wind-shear');
            console.log('Checking Windshear Detection checkbox:', windshearCheckbox ? 'FOUND' : 'NOT FOUND');
            
            if (windshearCheckbox) {
                windshearCheckbox.addEventListener('change', function() {
                    console.log(`[WINDSHEAR CHECKBOX] changed, checked=${this.checked}`);
                    
                    windshearActive = this.checked;
                    
                    // Update peta
                    console.log('[WINDSHEAR] Calling addMarkersToMap()...');
                    addMarkersToMap();
                    
                    // Show/hide legenda
                    if (windshearActive) {
                        document.getElementById('mapLegend').classList.add('show');
                    } else if (currentActiveLayer === null && activeAwosLayers.size === 0 && !windProfilerActive && !llwasActive) {
                        // Hide legenda hanya jika tidak ada layer yang aktif
                        document.getElementById('mapLegend').classList.remove('show');
                    }
                });
            } else {
                console.warn('Windshear Detection Checkbox not found!');
            }

            // ========== AWS DIGITAL LAYER ==========
            const awsDigitalCheckbox = document.getElementById('layer-aws-dig');
            console.log('Checking AWS Digital checkbox:', awsDigitalCheckbox ? 'FOUND' : 'NOT FOUND');
            
            if (awsDigitalCheckbox) {
                awsDigitalCheckbox.addEventListener('change', function() {
                    console.log(`[AWS DIGITAL CHECKBOX] changed, checked=${this.checked}`);
                    
                    awsDigitalActive = this.checked;
                    
                    // Update peta
                    console.log('[AWS DIGITAL] Calling addMarkersToMap()...');
                    addMarkersToMap();
                    
                    // Show/hide legenda
                    if (awsDigitalActive) {
                        document.getElementById('mapLegend').classList.add('show');
                    } else if (currentActiveLayer === null && activeAwosLayers.size === 0 && !windProfilerActive && !llwasActive && !windshearActive) {
                        // Hide legenda hanya jika tidak ada layer yang aktif
                        document.getElementById('mapLegend').classList.remove('show');
                    }
                });
            } else {
                console.warn('AWS Digital Checkbox not found!');
            }
        }

        function searchLocation() {
            const search = document.getElementById('searchLocation').value.toLowerCase();
            const found = allObservasiUdataAtasData.find(p => p['Stasiun'].toLowerCase().includes(search));
            
            if (found) {
                const lat = parseFloat(found['LAT']);
                const lon = parseFloat(found['LON']);
                if (!isNaN(lat) && !isNaN(lon)) {
                    map.setView([lat, lon], 16);
                }
            } else {
                alert('Lokasi tidak ditemukan');
            }
        }

        function resetMap() {
            map.setView([-2.5, 113.5], 5);
            document.getElementById('searchLocation').value = '';
            closePopup();
            closeDetailPopup();
        }

        function downloadData() {
            const csv = 'ID_Stasiun,Stasiun,LAT,LON,Kondisi\n' +
                allObservasiUdataAtasData.map(p => `${p['ID_Stasiun']},${p['Stasiun']},${p['LAT']},${p['LON']},${currentActiveLayer}`).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv; charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'data_observasi_udara_atas.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ==================== METADATA ====================
        function updateMetadata() {
            document.getElementById('totalData').textContent = allObservasiUdataAtasData.length;
            document.getElementById('uniqueLocations').textContent = new Set(allObservasiUdataAtasData.map(p => p['Stasiun'])).size;
            document.getElementById('lastUpdate').textContent = new Date().toLocaleDateString('id-ID');
            
            displayDataTable(allObservasiUdataAtasData);
        }

        function displayDataTable(data) {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = data.map((item, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${item['ID_Stasiun']}</td>
                    <td>${item['Stasiun']}</td>
                    <td>${item['LAT']}</td>
                    <td>${item['LON']}</td>
                    <td>${currentActiveLayer}</td>
                </tr>
            `).join('');
        }

        document.getElementById('tableSearch').addEventListener('keyup', function() {
            const search = this.value.toLowerCase();
            const filtered = allObservasiUdataAtasData.filter(p => 
                p['Stasiun'].toLowerCase().includes(search) || 
                p['ID_Stasiun'].toLowerCase().includes(search)
            );
            displayDataTable(filtered);
        });

        // ==================== FORM UPDATE DATA ====================
        document.getElementById('dataForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const newData = {
                ID_Stasiun: document.getElementById('namaLokasi').value,
                Stasiun: document.getElementById('namaLokasi').value,
                LAT: parseFloat(document.getElementById('latitude').value),
                LON: parseFloat(document.getElementById('longitude').value),
                kategori: document.getElementById('kategori').value || 'Lainnya'
            };

            allObservasiUdataAtasData.push(newData);

            showMessage('Data berhasil disimpan!', 'success');
            this.reset();

            // Update semua tampilan
            updateMetadata();
            addMarkersToMap();

            // Arahkan ke halaman peta
            setTimeout(() => switchPage('page1'), 1500);
        });

        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message ${type} show`;
            
            setTimeout(() => {
                messageEl.classList.remove('show');
            }, 3000);
        }

        // ==================== NAVIGASI ====================
        function switchPage(pageId) {
            // Sembunyikan semua page
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });

            // Tampilkan page yang dipilih
            document.getElementById(pageId).classList.add('active');

            // Update button aktif
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const pageId = this.getAttribute('data-page');
                switchPage(pageId);
            });
        });
    </script>
</body>

</html>

